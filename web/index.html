<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Dynamic Continuous Analysis Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --muted:#6b7280; --border:#e5e7eb; --tab:#e5e7eb; --active:#2563eb; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    header { display:flex; gap:16px; align-items:baseline; margin-bottom:16px; }
    h1 { margin:0; }
    .muted { color: var(--muted); }
    .card { border:1px solid var(--border); border-radius:12px; padding:16px; margin:12px 0; }
    .grid { display:grid; gap:12px; grid-template-columns: repeat(3, 1fr); }
    a { color:#2563eb; text-decoration:none; }
    table { border-collapse: collapse; width:100%; }
    th, td { padding:8px 10px; border-bottom:1px solid var(--border); text-align:left; }
    input[type="search"], input[type="datetime-local"] { padding:8px; border:1px solid var(--border); border-radius:8px; margin:8px 8px 8px 0;}
    code { background:#f7f7f7; padding:2px 4px; border-radius:6px; }
    .nowrap { white-space: nowrap; }
    .pill { background:#f3f4f6; border-radius:999px; padding:2px 8px; }
    .breadcrumb a { color: inherit; }
    .tabs { display:flex; gap:8px; border-bottom:1px solid var(--border); margin-bottom:16px; }
    .tab { padding:8px 12px; border:1px solid var(--tab); border-bottom:none; border-radius:8px 8px 0 0; background:#fafafa; }
    .tab.active { background:white; border-color: var(--active); color: var(--active); font-weight:600; }
    .controls { display:flex; flex-wrap:wrap; align-items:center; gap:8px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" integrity="sha256-LAEQ8l5cCwX6yFT1s1m8QX7wKjIvmyuHJ0v+qK2qTn0=" crossorigin="anonymous"></script>
</head>
<body>
  <header>
    <h1><a href="#/now">Dynamic Continuous Analysis Dashboard</a></h1>
    <span class="muted" id="updated"></span>
  </header>

  <div class="tabs">
    <a id="tab-now" class="tab" href="#/now">Monitoring</a>
    <a id="tab-hist" class="tab" href="#/hist">History</a>
  </div>

  <div id="app"></div>

  <script>
    const el = (t, p={}, ...kids) => {
      const n = document.createElement(t);
      for (const [k,v] of Object.entries(p||{})) {
        if (k === "class") n.className = v;
        else if (k === "html") n.innerHTML = v;
        else n.setAttribute(k, v);
      }
      kids.flat().forEach(k => n.append(k?.nodeType ? k : document.createTextNode(k ?? "")));
      return n;
    };

    // Create SVG elements correctly (HTML createElement won't render SVG tags)
    const svgEl = (t, p={}, ...kids) => {
      const n = document.createElementNS("http://www.w3.org/2000/svg", t);
      for (const [k,v] of Object.entries(p||{})) {
        n.setAttribute(k, v);
      }
      kids.flat().forEach(k => n.append(k?.nodeType ? k : document.createTextNode(k ?? "")));
      return n;
    };

    const fmtUTC = (epoch) => epoch ? new Date(epoch*1000).toUTCString() : "—";

    let DATA = null;

    async function load() {
      const res = await fetch("./data.json", {cache:"no-store"});
      DATA = await res.json();
      const d = new Date((DATA.generated_at||0)*1000);
      document.getElementById("updated").textContent = `Last updated: ${d.toUTCString()}`;
      route();
    }

    window.addEventListener("hashchange", route);
    window.addEventListener("load", load);

    function setActiveTab(kind){
      document.getElementById("tab-now").classList.toggle("active", kind==="now");
      document.getElementById("tab-hist").classList.toggle("active", kind==="hist");
    }

    function pickDataset(kind){
      if (!DATA || !DATA.datasets) return null;
      return kind === "hist" ? DATA.datasets.history : DATA.datasets.monitoring;
    }

    function route() {
      if (!DATA) return;
      const app = document.getElementById("app");
      app.innerHTML = "";
      const parts = location.hash.replace(/^#\/?/, "").split("/").filter(Boolean);
      const kind = (parts[0]==="hist") ? "hist" : "now";
      setActiveTab(kind);
      const ds = pickDataset(kind);
      const tail = parts.slice(1);

      if (tail.length === 0) return renderHome(app, ds, kind);
      if (tail[0] === "p" && tail[1] && tail.length === 2) return renderProject(app, ds, kind, tail[1]);
      if (tail[0] === "p" && tail[1] && tail[2] === "c" && tail[3] && tail.length === 4) return renderCommit(app, ds, kind, tail[1], tail[3]);
      if (tail[0] === "p" && tail[1] && tail[2] === "c" && tail[3] && tail[4] === "v" && tail[5]) return renderViolation(app, ds, kind, tail[1], tail[3], tail[5]);

      app.append(el("div", {}, "Not found"));
    }

    // --------- Common helpers ---------
    function breadcrumb(items){
      const nav = el("nav", {class:"breadcrumb muted"});
      items.forEach((it, i) => {
        nav.append(it.href ? el("a", {href: it.href}, it.text) : el("span", {}, it.text));
        if (i < items.length-1) nav.append(" / ");
      });
      return nav;
    }
    function findProject(ds, slug){ return (ds.projects||[]).find(p => p.slug === slug); }
    function findCommit(p, sha){ return (p.commits||[]).find(c => c.sha === sha); }
    function findViolation(c, id){ return (c.violations||[]).find(v => v.id === id); }

    // --------- Views ---------
    function renderHome(app, ds, kind){
      if (!ds) return app.append(el("div", {}, "No data"));
      const totals = ds.totals || {commits:0, locations:0};
      const summaryParts = [
        el("strong", {}, "Total projects: "), String((ds.projects||[]).length),
        " • ", el("strong", {}, "Total commits: "), String(totals.commits),
        " • ", el("strong", {}, "Total unique locations: "), String(totals.locations)
      ];
      
      // Add history-specific total
      if (kind === "hist" && typeof totals.new_locations_after_first === "number") {
        summaryParts.push(" • ", el("strong", {}, "New unique violations after first commit: "), String(totals.new_locations_after_first));
      }
      
      app.append(el("div", {class:"card"}, ...summaryParts));

      const grid = el("div", {class:"grid"});
      (ds.projects||[]).forEach(p => {
        const uniqueLocations = (p.commits||[]).reduce((a,c)=>a+(c.counts?.locations||0),0);
        // Latest commit timestamp for quick glance
        const lastTs = (p.commits||[]).reduce((m,c)=> Math.max(m, c.ts||0), 0);
        
        const pills = [
          el("span", {class:"pill"}, `Commits: ${p.commits.length}`),
          el("span", {class:"pill"}, `Unique locations: ${uniqueLocations}`)
        ];
        
        // Add history-specific pill
        if (kind === "hist" && typeof p.counts?.new_locations_after_first === "number") {
          pills.push(el("span", {class:"pill"}, `New after first: ${p.counts.new_locations_after_first}`));
        }
        
        const pillsContainer = el("div", {style:"margin-top:8px;"});
        pills.forEach((pill, i) => {
          if (i > 0) pillsContainer.append(" ");
          pillsContainer.append(pill);
        });
        
        grid.append(el("div", {class:"card"},
          el("h3", {}, el("a", {href:`#/${kind}/p/${p.slug}`}, p.full_name)),
          el("div", {class:"muted"}, `Latest artifact: ${p.latest_artifact_name || "N/A"}`),
          el("div", {class:"muted"}, `Latest commit time: ${fmtUTC(lastTs)}`),
          pillsContainer
        ));
      });
      app.append(grid);
    }

    function renderProject(app, ds, kind, slug){
      const p = findProject(ds, slug);
      if (!p) return app.append(el("div", {}, "Project not found"));
      app.append(breadcrumb([{href:`#/${kind}`, text:"Home"}, {text:p.full_name}]));

      // Controls: time range (UTC) + text filter
      const controls = el("div", {class:"controls"});
      const from = el("input", {type:"datetime-local", id:"from"});
      const to   = el("input", {type:"datetime-local", id:"to"});
      const search = el("input", {type:"search", placeholder:"Filter commits by SHA…", style:"width:320px;"});
      controls.append(el("span", {class:"muted"}, "From:"), from, el("span", {class:"muted"}, "To:"), to, search);
      app.append(controls);

      // Violations trend for each commit (entire series)
      const allCommits = (p.commits||[]);
      const valuesAll = allCommits.map(cc => (cc.counts && typeof cc.counts.locations === "number") ? cc.counts.locations : 0);
      const labelsAll = allCommits.map(cc => cc.sha.slice(0,7));
      if (valuesAll.length) {
        const maxValAll = Math.max(1, ...valuesAll);
        const Wp = 800, Hp = 220, Mp = {t:16, r:16, b:40, l:40};
        const innerWp = Wp - Mp.l - Mp.r;
        const innerHp = Hp - Mp.t - Mp.b;
        const stepXp = valuesAll.length > 1 ? innerWp / (valuesAll.length - 1) : 0;
        const toXp = i => Mp.l + i * stepXp;
        const toYp = v => Mp.t + (innerHp - (v / maxValAll) * innerHp);
        let dp = "";
        valuesAll.forEach((v, i) => {
          const x = toXp(i);
          const y = toYp(v);
          dp += (i === 0 ? `M ${x} ${y}` : ` L ${x} ${y}`);
        });
        const yticksP = [0, 0.25, 0.5, 0.75, 1].map(f => ({ y: Mp.t + (innerHp - f * innerHp), v: Math.round(maxValAll * f) }));
        // Sparse x ticks: first, quarter, half, three-quarter, last
        const xi = valuesAll.length - 1;
        const xtIdx = Array.from(new Set([0, Math.floor(xi*0.25), Math.floor(xi*0.5), Math.floor(xi*0.75), xi])).filter(i => i >= 0);
        const projChart = svgEl("svg", {width:String(Wp), height:String(Hp), viewBox:`0 0 ${Wp} ${Hp}`},
          yticksP.map(t => svgEl("line", {x1:String(Mp.l), y1:String(t.y), x2:String(Wp - Mp.r), y2:String(t.y), stroke:"#eef0f3"})),
          svgEl("line", {x1:String(Mp.l), y1:String(Mp.t), x2:String(Mp.l), y2:String(Hp - Mp.b), stroke:"#cbd5e1"}),
          svgEl("line", {x1:String(Mp.l), y1:String(Hp - Mp.b), x2:String(Wp - Mp.r), y2:String(Hp - Mp.b), stroke:"#cbd5e1"}),
          yticksP.map(t => svgEl("text", {x:String(Mp.l - 8), y:String(t.y + 4), fill:"#6b7280", "font-size":"10", "text-anchor":"end"}, String(t.v))),
          xtIdx.map(i => svgEl("text", {x:String(toXp(i)), y:String(Hp - Mp.b + 16), fill:"#6b7280", "font-size":"10", "text-anchor":"middle"}, labelsAll[i] || String(i+1))),
          svgEl("path", {d: dp, fill:"none", stroke:"#2563eb", "stroke-width":"2"}),
          valuesAll.map((v,i) => svgEl("circle", {cx:String(toXp(i)), cy:String(toYp(v)), r:"2.5", fill:"#2563eb"}, svgEl("title", {}, `${labelsAll[i] || (i+1)}: ${v}`)))
        );
        // Weekly stats (last 7 days)
        const nowEpoch = Math.floor(Date.now() / 1000);
        const weekAgo = nowEpoch - 7*24*60*60;
        const commitsWeek = (allCommits||[]).filter(cc => (cc.ts||0) >= weekAgo);
        const weekCommitCount = commitsWeek.length;
        const weekViolations = commitsWeek.reduce((a,cc) => a + ((cc.counts && typeof cc.counts.locations === "number") ? cc.counts.locations : 0), 0);

        // History-specific: new violations after first commit
        const newAfterFirst = (p.counts && typeof p.counts.new_locations_after_first === "number") 
          ? p.counts.new_locations_after_first 
          : 0;

        // Layout: chart (left) + status board (right)
        const row = el("div", {style:"display:flex; gap:12px; align-items:stretch; flex-wrap:wrap;"});
        const chartCard = el("div", {class:"card", style:"flex:1; min-width:520px;"},
          el("h3", {}, "Violations trend per commit"),
          projChart,
          el("div", {class:"muted"}, `Commits: ${valuesAll.length} • Max violations: ${maxValAll}`)
        );
        
        const statsTitle = kind === "hist" ? "History Stats" : "Last 7 days";
        const statsItems = [
          el("div", {},
            el("div", {class:"muted"}, "New commits"),
            el("div", {style:"font-size:28px; font-weight:700;"}, String(weekCommitCount))
          ),
          el("div", {},
            el("div", {class:"muted"}, "New violations"),
            el("div", {style:"font-size:28px; font-weight:700;"}, String(weekViolations))
          )
        ];
        
        // Add history-specific metric
        if (kind === "hist") {
          statsItems.push(el("div", {},
            el("div", {class:"muted"}, "New unique violations after first commit"),
            el("div", {style:"font-size:28px; font-weight:700;"}, String(newAfterFirst))
          ));
        }
        
        const statsCard = el("div", {class:"card", style:"width:360px; display:flex; flex-direction:column; justify-content:center;"},
          el("h3", {}, statsTitle),
          el("div", {style:"display:flex; flex-direction:column; gap:12px;"}, ...statsItems)
        );
        row.append(chartCard, statsCard);
        app.append(row);
      }

      // Table
      const table = el("table",
        {},
        el("thead", {}, el("tr", {},
          el("th", {}, "Commit"),
          el("th", {}, "Timestamp (UTC)"),
          el("th", {}, "Unique Violations")
        )),
        el("tbody")
      );
      const tbody = table.querySelector("tbody");
      app.append(table);

      // Preserve the CSV order exactly (CSV may be newest-first). If current display
      // appears reversed relative to the CSV, flip once here to match CSV.
      const commits = (p.commits||[]).slice().reverse();

      function parseLocalDT(val){
        if (!val) return null;
        const d = new Date(val);
        return isNaN(d.getTime()) ? null : Math.floor(d.getTime()/1000);
      }

      function draw(){
        tbody.innerHTML = "";
        const q = (search.value||"").toLowerCase();
        const fromEpoch = parseLocalDT(from.value);
        const toEpoch = parseLocalDT(to.value);

        commits
          .filter(c => !q || c.sha.toLowerCase().includes(q))
          .filter(c => fromEpoch==null || (c.ts||0) >= fromEpoch)
          .filter(c => toEpoch==null || (c.ts||0) <= toEpoch)
          .forEach(c => {
            tbody.append(el("tr", {},
              el("td", {}, el("a", {href:`#/${kind}/p/${p.slug}/c/${c.sha}`, class:"nowrap"}, c.sha)),
              el("td", {}, fmtUTC(c.ts)),
              el("td", {}, String(c.counts.locations))
            ));
          });
      }
      from.addEventListener("change", draw);
      to.addEventListener("change", draw);
      search.addEventListener("input", draw);
      draw();
    }

    function renderCommit(app, ds, kind, slug, sha){
      const p = findProject(ds, slug);
      if (!p) return app.append(el("div", {}, "Project not found"));
      const c = findCommit(p, sha);
      if (!c) return app.append(el("div", {}, "Commit not found"));

      app.append(breadcrumb([
        {href:`#/${kind}`, text:"Home"},
        {href:`#/${kind}/p/${p.slug}`, text:p.full_name},
        {text: sha}
      ]));

      // --- SAFER HEADER (avoid crashes if counts is missing) ---
      const uniqLoc = (c.counts && typeof c.counts.locations === "number")
        ? c.counts.locations
        : 0; // or use "—" if you prefer

      app.append(el("div", {class:"card"},
        el("div", {}, el("strong", {}, "Commit: "), el("code", {}, sha)),
        el("div", {}, el("strong", {}, "Timestamp: "), fmtUTC(c.ts)),
        el("div", {}, el("strong", {}, "Unique Violations: "), String(uniqLoc))
      ));
      // ---------------------------------------------------------
      // --- SAFER TABLE (avoid crashes if violations is missing) ---
      const input = el("input", {type:"search", placeholder:"Filter by file/spec…", style:"width:320px;"});
      app.append(input);

      const table = el("table",
        {},
        el("thead", {}, el("tr", {},
          el("th", {}, "File"),
          el("th", {}, "Line"),
          el("th", {}, "Specs"),
          el("th", {}, "Total (distinct specs)"),
          el("th", {}, "Details")
        )),
        el("tbody")
      );
      const tbody = table.querySelector("tbody");

      function draw(){
        tbody.innerHTML = "";
        const q = (input.value||"").toLowerCase();
        (c.violations || [])
          .filter(v =>
            v.file.toLowerCase().includes(q) ||
            String(v.line).includes(q) ||
            (v.specs||"").toLowerCase().includes(q)
          )
          .forEach(v => {
            tbody.append(el("tr", {},
              el("td", {class:"nowrap"}, v.file),
              el("td", {}, String(v.line)),
              el("td", {}, v.specs || "—"),
              el("td", {}, String(v.count || 0)),
              el("td", {}, el("a", {href:`#/${kind}/p/${p.slug}/c/${sha}/v/${v.id}`, class:"nowrap"}, "Open"))
            ));
          });
      }
      input.addEventListener("input", draw);
      draw();
      app.append(table);
    }

    function renderViolation(app, ds, kind, slug, sha, id){
      const p = findProject(ds, slug);
      if (!p) return app.append(el("div", {}, "Project not found"));
      const c = findCommit(p, sha);
      if (!c) return app.append(el("div", {}, "Commit not found"));
      const v = findViolation(c, id);
      if (!v) return app.append(el("div", {}, "Violation not found"));

      app.append(breadcrumb([
        {href:`#/${kind}`, text:"Home"},
        {href:`#/${kind}/p/${p.slug}`, text:p.full_name},
        {href:`#/${kind}/p/${p.slug}/c/${sha}`, text: sha},
        {text: v.id}
      ]));

      app.append(el("div", {class:"card"},
        el("div", {}, el("strong", {}, "Project: "), p.full_name),
        el("div", {}, el("strong", {}, "Commit: "), el("code", {}, sha)),
        el("div", {}, el("strong", {}, "File: "), v.file, " : ", String(v.line)),
        el("div", {}, el("strong", {}, "Specs: "), v.specs || "—"),
        el("div", {}, el("strong", {}, "Total (distinct specs): "), String(v.count || 0))
      ));

      const bd = v.breakdown || [];
      const table = el("table",
        {},
        el("thead", {}, el("tr", {}, el("th", {}, "Spec"), el("th", {}, "Count"))),
        el("tbody", {}, ...(bd.length ? bd.map(b =>
          el("tr", {}, el("td", {}, b.spec), el("td", {}, String(b.count)))
        ) : [el("tr", {}, el("td", {colspan:"2"}, el("span", {class:"muted"}, "No spec entries found.")))]))
      );
      app.append(el("div", {class:"card"},
        el("h3", {}, "Spec breakdown"),
        table
      ));
    }
  </script>
</body>
</html>