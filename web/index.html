<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Dynamic Continuous Analysis Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --muted:#6b7280; --border:#e5e7eb; --tab:#e5e7eb; --active:#2563eb; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    header { display:flex; gap:16px; align-items:baseline; margin-bottom:16px; }
    h1 { margin:0; }
    .muted { color: var(--muted); }
    .card { border:1px solid var(--border); border-radius:12px; padding:16px; margin:12px 0; }
    .grid { display:grid; gap:12px; grid-template-columns: repeat(3, 1fr); }
    a { color:#2563eb; text-decoration:none; }
    table { border-collapse: collapse; width:100%; }
    th, td { padding:8px 10px; border-bottom:1px solid var(--border); text-align:left; }
    input[type="search"], input[type="datetime-local"] { padding:8px; border:1px solid var(--border); border-radius:8px; margin:8px 8px 8px 0;}
    code { background:#f7f7f7; padding:2px 4px; border-radius:6px; }
    .nowrap { white-space: nowrap; }
    .pill { background:#f3f4f6; border-radius:999px; padding:2px 8px; }
    .breadcrumb a { color: inherit; }
    .tabs { display:flex; gap:8px; border-bottom:1px solid var(--border); margin-bottom:16px; }
    .tab { padding:8px 12px; border:1px solid var(--tab); border-bottom:none; border-radius:8px 8px 0 0; background:#fafafa; }
    .tab.active { background:white; border-color: var(--active); color: var(--active); font-weight:600; }
    .controls { display:flex; flex-wrap:wrap; align-items:center; gap:8px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" integrity="sha256-LAEQ8l5cCwX6yFT1s1m8QX7wKjIvmyuHJ0v+qK2qTn0=" crossorigin="anonymous"></script>
</head>
<body>
  <header>
    <h1><a href="#/now">Dynamic Continuous Analysis Dashboard</a></h1>
    <span class="muted" id="updated"></span>
  </header>

  <div class="tabs">
    <a id="tab-now" class="tab" href="#/now">Monitoring</a>
    <a id="tab-hist" class="tab" href="#/hist">History</a>
  </div>

  <div id="app"></div>

  <script>
    const el = (t, p={}, ...kids) => {
      const n = document.createElement(t);
      for (const [k,v] of Object.entries(p||{})) {
        if (k === "class") n.className = v;
        else if (k === "html") n.innerHTML = v;
        else n.setAttribute(k, v);
      }
      kids.flat().forEach(k => n.append(k?.nodeType ? k : document.createTextNode(k ?? "")));
      return n;
    };

    // Create SVG elements correctly (HTML createElement won't render SVG tags)
    const svgEl = (t, p={}, ...kids) => {
      const n = document.createElementNS("http://www.w3.org/2000/svg", t);
      for (const [k,v] of Object.entries(p||{})) {
        n.setAttribute(k, v);
      }
      kids.flat().forEach(k => n.append(k?.nodeType ? k : document.createTextNode(k ?? "")));
      return n;
    };

    const fmtUTC = (epoch) => epoch ? new Date(epoch*1000).toUTCString() : "—";
    
    const fmtET = (epoch) => {
      if (!epoch) return "—";
      const d = new Date(epoch * 1000);
      // Convert to Eastern Time
      const etString = d.toLocaleString("en-US", {
        timeZone: "America/New_York",
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false
      });
      return etString;
    };

    let DATA = null;

    async function load() {
      const res = await fetch("./data.json", {cache:"no-store"});
      DATA = await res.json();
      const d = new Date((DATA.generated_at||0)*1000);
      document.getElementById("updated").textContent = `Last updated: ${d.toUTCString()}`;
      route();
    }

    window.addEventListener("hashchange", route);
    window.addEventListener("load", load);

    function setActiveTab(kind){
      document.getElementById("tab-now").classList.toggle("active", kind==="now");
      document.getElementById("tab-hist").classList.toggle("active", kind==="hist");
    }

    function pickDataset(kind){
      if (!DATA || !DATA.datasets) return null;
      return kind === "hist" ? DATA.datasets.history : DATA.datasets.monitoring;
    }

    function route() {
      if (!DATA) return;
      const app = document.getElementById("app");
      app.innerHTML = "";
      const parts = location.hash.replace(/^#\/?/, "").split("/").filter(Boolean);
      const kind = (parts[0]==="hist") ? "hist" : "now";
      setActiveTab(kind);
      const ds = pickDataset(kind);
      const tail = parts.slice(1);

      if (tail.length === 0) return renderHome(app, ds, kind);
      if (tail[0] === "p" && tail[1] && tail.length === 2) return renderProject(app, ds, kind, tail[1]);
      if (tail[0] === "p" && tail[1] && tail[2] === "c" && tail[3] && tail.length === 4) return renderCommit(app, ds, kind, tail[1], tail[3]);
      if (tail[0] === "p" && tail[1] && tail[2] === "c" && tail[3] && tail[4] === "v" && tail[5]) return renderViolation(app, ds, kind, tail[1], tail[3], tail[5]);

      app.append(el("div", {}, "Not found"));
    }

    // --------- Common helpers ---------
    function breadcrumb(items){
      const nav = el("nav", {class:"breadcrumb muted"});
      items.forEach((it, i) => {
        nav.append(it.href ? el("a", {href: it.href}, it.text) : el("span", {}, it.text));
        if (i < items.length-1) nav.append(" / ");
      });
      return nav;
    }
    function findProject(ds, slug){ return (ds.projects||[]).find(p => p.slug === slug); }
    function findCommit(p, sha){ return (p.commits||[]).find(c => c.sha === sha); }
    function findViolation(c, id){ return (c.violations||[]).find(v => v.id === id); }

    // --------- Views ---------
    function renderHome(app, ds, kind){
      if (!ds) return app.append(el("div", {}, "No data"));
      const totals = ds.totals || {commits:0, locations:0};
      const summaryParts = [
        el("strong", {}, "Total projects: "), String((ds.projects||[]).length),
        " • ", el("strong", {}, "Total commits: "), String(totals.commits),
        " • ", el("strong", {}, "Total unique violations: "), String(totals.locations)
      ];
      
      // Add history-specific total
      if (kind === "hist" && typeof totals.new_locations_after_first === "number") {
        summaryParts.push(" • ", el("strong", {}, "New unique violations after first commit: "), String(totals.new_locations_after_first));
      }
      
      app.append(el("div", {class:"card"}, ...summaryParts));

      const grid = el("div", {class:"grid"});
      (ds.projects||[]).forEach(p => {
        const uniqueLocations = (p.commits||[]).reduce((a,c)=>a+(c.counts?.locations||0),0);
        // Latest commit timestamp for quick glance
        const lastTs = (p.commits||[]).reduce((m,c)=> Math.max(m, c.ts||0), 0);
        
        const pills = [
          el("span", {class:"pill"}, `Commits: ${p.commits.length}`),
          el("span", {class:"pill"}, `Unique violations: ${uniqueLocations}`)
        ];
        
        // Add history-specific pill
        if (kind === "hist" && typeof p.counts?.new_locations_after_first === "number") {
          pills.push(el("span", {class:"pill"}, `New after first: ${p.counts.new_locations_after_first}`));
        }
        
        const pillsContainer = el("div", {style:"margin-top:8px;"});
        pills.forEach((pill, i) => {
          if (i > 0) pillsContainer.append(" ");
          pillsContainer.append(pill);
        });
        
        grid.append(el("div", {class:"card"},
          el("h3", {}, el("a", {href:`#/${kind}/p/${p.slug}`}, p.full_name)),
          el("div", {class:"muted"}, `Latest artifact: ${p.latest_artifact_name || "N/A"}`),
          el("div", {class:"muted"}, `Latest commit time: ${fmtUTC(lastTs)}`),
          pillsContainer
        ));
      });
      app.append(grid);
    }

    function renderProject(app, ds, kind, slug){
      const p = findProject(ds, slug);
      if (!p) return app.append(el("div", {}, "Project not found"));
      app.append(breadcrumb([{href:`#/${kind}`, text:"Home"}, {text:p.full_name}]));

      // Controls: time range (UTC) + text filter
      const controls = el("div", {class:"controls"});
      const from = el("input", {type:"datetime-local", id:"from"});
      const to   = el("input", {type:"datetime-local", id:"to"});
      const search = el("input", {type:"search", placeholder:"Filter commits by SHA…", style:"width:320px;"});
      controls.append(el("span", {class:"muted"}, "From:"), from, el("span", {class:"muted"}, "To:"), to, search);
      app.append(controls);

      // Project Metadata box (only show for monitoring runs, not history runs)
      if (kind === "now" && (p.shadowed_repo || p.url || p.date_shadowing_started)) {
        const urlBoxContent = [
          el("h3", {style:"margin-top:0; margin-bottom:12px;"}, "Project Metadata")
        ];

        // Project URL (first element)
        urlBoxContent.push(
          el("div", {style:"display:flex; align-items:center; gap:8px; margin-bottom:8px;"},
            el("span", {}, "Project URL: "),
            p.url 
              ? el("a", {href:p.url, target:"_blank", style:"color:#2563eb; word-break:break-all;"}, p.url)
              : el("span", {class:"muted"}, "—")
          )
        );
        
        // Shadowed Project URL (second element with https://github.com/ prepended)
        const shadowedUrl = p.shadowed_repo ? `https://github.com/${p.shadowed_repo}` : null;
        urlBoxContent.push(
          el("div", {style:"display:flex; align-items:center; gap:8px; margin-bottom:8px;"},
            el("span", {}, "Shadowed Project URL: "),
            shadowedUrl 
              ? el("a", {href:shadowedUrl, target:"_blank", style:"color:#2563eb; word-break:break-all;"}, shadowedUrl)
              : el("span", {class:"muted"}, "—")
          )
        );
        
        // Date shadowing started (third element)
        urlBoxContent.push(
          el("div", {style:"display:flex; align-items:center; gap:8px;"},
            el("span", {}, "Date shadowing started: "),
            p.date_shadowing_started 
              ? el("span", {}, p.date_shadowing_started)
              : el("span", {class:"muted"}, "—")
          )
        );
        
        app.append(el("div", {class:"card", style:"width:100%; margin-bottom:6px; background:#f8f9fa; box-sizing:border-box;"}, ...urlBoxContent));
      }

      // Violations trend for each commit (entire series)
      const allCommits = (p.commits||[]);
      const valuesAll = allCommits.map(cc => (cc.num_current_violations !== undefined && cc.num_current_violations !== null) ? (typeof cc.num_current_violations === "number" ? cc.num_current_violations : 0) : 0);
      const labelsAll = allCommits.map(cc => cc.sha.slice(0,7));
      if (valuesAll.length) {
        const maxValAll = Math.max(1, ...valuesAll);
        const Wp = 800, Hp = 220, Mp = {t:16, r:16, b:40, l:40};
        const innerWp = Wp - Mp.l - Mp.r;
        const innerHp = Hp - Mp.t - Mp.b;
        const stepXp = valuesAll.length > 1 ? innerWp / (valuesAll.length - 1) : 0;
        const toXp = i => Mp.l + i * stepXp;
        const toYp = v => Mp.t + (innerHp - (v / maxValAll) * innerHp);
        let dp = "";
        valuesAll.forEach((v, i) => {
          const x = toXp(i);
          const y = toYp(v);
          dp += (i === 0 ? `M ${x} ${y}` : ` L ${x} ${y}`);
        });
        const yticksP = [0, 0.25, 0.5, 0.75, 1].map(f => ({ y: Mp.t + (innerHp - f * innerHp), v: Math.round(maxValAll * f) }));
        // Sparse x ticks: first, quarter, half, three-quarter, last
        const xi = valuesAll.length - 1;
        const xtIdx = Array.from(new Set([0, Math.floor(xi*0.25), Math.floor(xi*0.5), Math.floor(xi*0.75), xi])).filter(i => i >= 0);
        const projChart = svgEl("svg", {width:String(Wp), height:String(Hp), viewBox:`0 0 ${Wp} ${Hp}`},
          yticksP.map(t => svgEl("line", {x1:String(Mp.l), y1:String(t.y), x2:String(Wp - Mp.r), y2:String(t.y), stroke:"#eef0f3"})),
          svgEl("line", {x1:String(Mp.l), y1:String(Mp.t), x2:String(Mp.l), y2:String(Hp - Mp.b), stroke:"#cbd5e1"}),
          svgEl("line", {x1:String(Mp.l), y1:String(Hp - Mp.b), x2:String(Wp - Mp.r), y2:String(Hp - Mp.b), stroke:"#cbd5e1"}),
          yticksP.map(t => svgEl("text", {x:String(Mp.l - 8), y:String(t.y + 4), fill:"#6b7280", "font-size":"10", "text-anchor":"end"}, String(t.v))),
          xtIdx.map(i => svgEl("text", {x:String(toXp(i)), y:String(Hp - Mp.b + 16), fill:"#6b7280", "font-size":"10", "text-anchor":"middle"}, labelsAll[i] || String(i+1))),
          svgEl("path", {d: dp, fill:"none", stroke:"#2563eb", "stroke-width":"2"}),
          valuesAll.map((v,i) => svgEl("circle", {cx:String(toXp(i)), cy:String(toYp(v)), r:"2.5", fill:"#2563eb"}, svgEl("title", {}, `${labelsAll[i] || (i+1)}: ${v}`)))
        );
        // Stats calculation
        let statsTitle, statsItems;
        
        if (kind === "hist") {
          // For history runs: show total commits and violations across all time
          const totalCommits = allCommits.length;
          const totalViolations = allCommits.reduce((a,cc) => a + ((cc.counts && typeof cc.counts.locations === "number") ? cc.counts.locations : 0), 0);
          const newAfterFirst = (p.counts && typeof p.counts.new_locations_after_first === "number") 
            ? p.counts.new_locations_after_first 
            : 0;
          
          statsTitle = "History Stats";
          statsItems = [
            el("div", {},
              el("div", {class:"muted"}, "Total commits"),
              el("div", {style:"font-size:28px; font-weight:700;"}, String(totalCommits))
            ),
            el("div", {},
              el("div", {class:"muted"}, "Total violations"),
              el("div", {style:"font-size:28px; font-weight:700;"}, String(totalViolations))
            ),
            el("div", {},
              el("div", {class:"muted"}, "New unique violations after first commit"),
              el("div", {style:"font-size:28px; font-weight:700;"}, String(newAfterFirst))
            )
          ];
        } else {
          // For monitoring runs: show last 7 days stats
          const nowEpoch = Math.floor(Date.now() / 1000);
          const weekAgo = nowEpoch - 7*24*60*60;
          const commitsWeek = (allCommits||[]).filter(cc => (cc.ts||0) >= weekAgo);
          const weekCommitCount = commitsWeek.length;
          const weekViolations = commitsWeek.reduce((a,cc) => a + ((cc.counts && typeof cc.counts.locations === "number") ? cc.counts.locations : 0), 0);
          
          statsTitle = "Last 7 days";
          statsItems = [
            el("div", {},
              el("div", {class:"muted"}, "New commits"),
              el("div", {style:"font-size:28px; font-weight:700;"}, String(weekCommitCount))
            ),
            el("div", {},
              el("div", {class:"muted"}, "New violations"),
              el("div", {style:"font-size:28px; font-weight:700;"}, String(weekViolations))
            )
          ];
        }

        // Layout: chart (left) + status board (right)
        const row = el("div", {style:"display:flex; gap:12px; align-items:stretch; flex-wrap:wrap;"});
        const chartCard = el("div", {class:"card", style:"flex:1; min-width:520px;"},
          el("h3", {}, "Violations trend per commit"),
          projChart,
          el("div", {class:"muted"}, `Commits: ${valuesAll.length} • Max violations: ${maxValAll}`)
        );
        
        const statsCard = el("div", {class:"card", style:"width:360px; display:flex; flex-direction:column; justify-content:center;"},
          el("h3", {}, statsTitle),
          el("div", {style:"display:flex; flex-direction:column; gap:12px;"}, ...statsItems)
        );
        row.append(chartCard, statsCard);
        app.append(row);
      }

      // Check if any commits have coverage data
      const commits = (p.commits||[]).slice().reverse();
      const hasCoverage = commits.some(c => c.coverage !== undefined && c.coverage !== null);

      // Table header
      const tableHeaders = [
        el("th", {}, "Commit"),
        el("th", {}, "Commit Message"),
        el("th", {}, "Timestamp (ET)")
      ];
      
      // Add Files Changed column for history runs
      if (kind === "hist") {
        tableHeaders.push(el("th", {}, "Files Changed"));
      }
      
      tableHeaders.push(el("th", {}, "Unique Violations"));
      
      if (hasCoverage) {
        tableHeaders.push(el("th", {}, "Coverage"));
      }

      const table = el("table",
        {},
        el("thead", {}, el("tr", {}, ...tableHeaders)),
        el("tbody")
      );
      const tbody = table.querySelector("tbody");
      app.append(table);

      function parseLocalDT(val){
        if (!val) return null;
        const d = new Date(val);
        return isNaN(d.getTime()) ? null : Math.floor(d.getTime()/1000);
      }

      function draw(){
        tbody.innerHTML = "";
        const q = (search.value||"").toLowerCase();
        const fromEpoch = parseLocalDT(from.value);
        const toEpoch = parseLocalDT(to.value);

        commits
          .filter(c => !q || c.sha.toLowerCase().includes(q))
          .filter(c => fromEpoch==null || (c.ts||0) >= fromEpoch)
          .filter(c => toEpoch==null || (c.ts||0) <= toEpoch)
          .forEach((c, idx, filteredCommits) => {

            // Get violation counts from CSV data
            const numCurrent = c.num_current_violations ?? 0;
            const numNew = c.num_new_violations ?? 0;
            const numOld = c.num_old_violations ?? 0;

            // Build violation display: grey current, red delta +, green delta -
            const violationParts = [el("span", {style:"color:#6b7280;"}, String(numCurrent))];

            // Show deltas only if non-zero, or if both are zero show grey zero
            if (numNew > 0 && numOld > 0) {
              violationParts.push(el("span", {style:"color:#dc2626; margin-left:8px;"}, `(+${numNew})`));
              violationParts.push(el("span", {style:"color:#16a34a; margin-left:4px;"}, `(-${numOld})`));
            } else if (numNew > 0) {
              violationParts.push(el("span", {style:"color:#dc2626; margin-left:8px;"}, `(+${numNew})`));
            } else if (numOld > 0) {
              violationParts.push(el("span", {style:"color:#16a34a; margin-left:8px;"}, `(-${numOld})`));
            } else if (numNew === 0 && numOld === 0) {
              violationParts.push(el("span", {style:"color:#6b7280; margin-left:8px;"}, "(0)"));
            }

            // Only use current_commit_timestamp, show "x" if not available
            const displayTimestamp = c.current_commit_timestamp ? fmtET(c.current_commit_timestamp) : "x";
            
            // Truncate commit message if too long
            const commitMessage = c.current_commit_message || "";
            const shortMessage = commitMessage.length > 100 ? commitMessage.substring(0, 97) + "..." : commitMessage;
            
            const rowCells = [
              el("td", {style:"min-width:80px;"}, el("a", {href:`#/${kind}/p/${p.slug}/c/${c.current_commit_sha || c.sha}`, class:"nowrap"}, (c.current_commit_sha || c.sha).slice(0,7))),
              el("td", {title: commitMessage, style:"max-width:600px;"}, shortMessage),
              el("td", {style:"min-width:140px;"}, displayTimestamp)
            ];
            
            // Add Files Changed column for history runs
            if (kind === "hist") {
              const numFiles = c.num_python_file_changed !== undefined && c.num_python_file_changed !== null 
                ? String(c.num_python_file_changed) 
                : "—";
              rowCells.push(el("td", {style:"min-width:100px;"}, numFiles));
            }
            
            rowCells.push(el("td", {style:"min-width:120px; text-align:left;"}, ...violationParts));
            
            if (hasCoverage) {
              const coverageDisplay = (c.coverage !== undefined && c.coverage !== null) 
                ? (typeof c.coverage === "number" ? `${c.coverage.toFixed(2)}%` : String(c.coverage))
                : "—";
              rowCells.push(el("td", {}, coverageDisplay));
            }
            
            tbody.append(el("tr", {}, ...rowCells));
          });
      }
      from.addEventListener("change", draw);
      to.addEventListener("change", draw);
      search.addEventListener("input", draw);
      draw();
    }

    function renderCommit(app, ds, kind, slug, sha){
      const p = findProject(ds, slug);
      if (!p) return app.append(el("div", {}, "Project not found"));
      const c = findCommit(p, sha);
      if (!c) return app.append(el("div", {}, "Commit not found"));

      app.append(breadcrumb([
        {href:`#/${kind}`, text:"Home"},
        {href:`#/${kind}/p/${p.slug}`, text:p.full_name},
        {text: sha}
      ]));

      // --- SAFER HEADER (avoid crashes if counts is missing) ---
      const numCurrent = c.num_current_violations ?? 0;
      const numNew = c.num_new_violations ?? 0;
      const numOld = c.num_old_violations ?? 0;

      const commitInfo = [
        el("div", {}, el("strong", {}, "Commit: "), el("code", {}, sha))
      ];
      
      // Add commit message - always show, even if missing
      const commitMessage = c.current_commit_message || "x";
      commitInfo.push(el("div", {}, el("strong", {}, "Commit Message: "), commitMessage));
      
      // Add commit timestamp - always show, even if missing
      const displayTimestamp = c.current_commit_timestamp ? fmtET(c.current_commit_timestamp) : "x";
      commitInfo.push(el("div", {}, el("strong", {}, "Timestamp: "), displayTimestamp));
      
      // Add GitHub URL and Files Changed for history runs
      if (kind === "hist") {
        // Add GitHub URL
        if (c.github_url && c.github_url.trim()) {
          commitInfo.push(el("div", {}, el("strong", {}, "GitHub URL: "), el("a", {href: c.github_url, target: "_blank"}, c.github_url)));
        }
        
        // Add Files Changed
        const numFiles = c.num_python_file_changed !== undefined && c.num_python_file_changed !== null 
          ? String(c.num_python_file_changed) 
          : "—";
        commitInfo.push(el("div", {}, el("strong", {}, "Files Changed: "), numFiles));
      }
      
      // Add GitHub compare URL for monitoring runs
      if (kind === "now") {
        // Find previous commit to generate compare URL
        const allCommits = (p.commits||[]).slice().reverse();
        const currentSha = c.current_commit_sha || c.sha;
        const currentIdx = allCommits.findIndex(oc => (oc.current_commit_sha || oc.sha) === currentSha);
        const previousCommit = currentIdx > 0 ? allCommits[currentIdx - 1] : null;
        
        // Generate GitHub compare URL
        if (p.url && currentSha) {
          const urlMatch = p.url.match(/github\.com\/([^\/]+\/[^\/]+)/);
          if (urlMatch) {
            const repoPath = urlMatch[1];
            let githubUrl;
            if (previousCommit) {
              const previousSha = previousCommit.current_commit_sha || previousCommit.sha;
              if (previousSha) {
                githubUrl = `https://github.com/${repoPath}/compare/${previousSha}...${currentSha}`;
              } else {
                githubUrl = `https://github.com/${repoPath}/commit/${currentSha}`;
              }
            } else {
              githubUrl = `https://github.com/${repoPath}/commit/${currentSha}`;
            }
            commitInfo.push(el("div", {}, el("strong", {}, "GitHub URL: "), el("a", {href: githubUrl, target: "_blank"}, githubUrl)));
          }
        }
      }
      
      // Build violation display: grey current, red delta +, green delta -
      const violationParts = [el("span", {style:"color:#6b7280;"}, String(numCurrent))];
      if (numNew > 0 && numOld > 0) {
        violationParts.push(el("span", {style:"color:#dc2626; margin-left:8px;"}, `(+${numNew})`));
        violationParts.push(el("span", {style:"color:#16a34a; margin-left:4px;"}, `(-${numOld})`));
      } else if (numNew > 0) {
        violationParts.push(el("span", {style:"color:#dc2626; margin-left:8px;"}, `(+${numNew})`));
      } else if (numOld > 0) {
        violationParts.push(el("span", {style:"color:#16a34a; margin-left:8px;"}, `(-${numOld})`));
      } else if (numNew === 0 && numOld === 0) {
        violationParts.push(el("span", {style:"color:#6b7280; margin-left:8px;"}, "(0)"));
      }
      commitInfo.push(el("div", {}, el("strong", {}, "Unique Violations: "), ...violationParts));
      
      // Add coverage if available
      if (c.coverage !== undefined && c.coverage !== null) {
        const coverageDisplay = typeof c.coverage === "number" ? `${c.coverage.toFixed(2)}%` : String(c.coverage);
        commitInfo.push(el("div", {}, el("strong", {}, "Coverage: "), coverageDisplay));
      }
      
      app.append(el("div", {class:"card"}, ...commitInfo));
      // ---------------------------------------------------------
      // --- SAFER TABLE (avoid crashes if violations is missing) ---
      const input = el("input", {type:"search", placeholder:"Filter by file/spec…", style:"width:320px;"});
      app.append(input);

      const table = el("table",
        {},
        el("thead", {}, el("tr", {},
          el("th", {}, "File"),
          el("th", {}, "Line"),
          el("th", {}, "Specs"),
          el("th", {}, "Total Occurrences"),
          el("th", {}, "Details")
        )),
        el("tbody")
      );
      const tbody = table.querySelector("tbody");

      function draw(){
        tbody.innerHTML = "";
        const q = (input.value||"").toLowerCase();
        (c.violations || [])
          .filter(v =>
            v.file.toLowerCase().includes(q) ||
            String(v.line).includes(q) ||
            (v.specs||"").toLowerCase().includes(q)
          )
          .forEach(v => {
            tbody.append(el("tr", {},
              el("td", {class:"nowrap"}, v.file),
              el("td", {}, String(v.line)),
              el("td", {}, v.specs || "—"),
              el("td", {}, String(v.count || 0)),
              el("td", {}, el("a", {href:`#/${kind}/p/${p.slug}/c/${sha}/v/${v.id}`, class:"nowrap"}, "Open"))
            ));
          });
      }
      input.addEventListener("input", draw);
      draw();
      app.append(table);
    }

    function renderViolation(app, ds, kind, slug, sha, id){
      const p = findProject(ds, slug);
      if (!p) return app.append(el("div", {}, "Project not found"));
      const c = findCommit(p, sha);
      if (!c) return app.append(el("div", {}, "Commit not found"));
      const v = findViolation(c, id);
      if (!v) return app.append(el("div", {}, "Violation not found"));

      app.append(breadcrumb([
        {href:`#/${kind}`, text:"Home"},
        {href:`#/${kind}/p/${p.slug}`, text:p.full_name},
        {href:`#/${kind}/p/${p.slug}/c/${sha}`, text: sha},
        {text: v.id}
      ]));

      const violationInfo = [
        el("div", {}, el("strong", {}, "Project: "), p.full_name),
        el("div", {}, el("strong", {}, "Commit: "), el("code", {}, sha)),
        el("div", {}, el("strong", {}, "File: "), v.file, " : ", String(v.line)),
        el("div", {}, el("strong", {}, "Specs: "), v.specs || "—"),
        el("div", {}, el("strong", {}, "Total Occurrences: "), String(v.count || 0))
      ];
      
      // Add coverage if available for this commit
      if (c.coverage !== undefined && c.coverage !== null) {
        const coverageDisplay = typeof c.coverage === "number" ? `${c.coverage.toFixed(2)}%` : String(c.coverage);
        violationInfo.push(el("div", {}, el("strong", {}, "Coverage: "), coverageDisplay));
      }
      
      app.append(el("div", {class:"card"}, ...violationInfo));

      const bd = v.breakdown || [];
      const table = el("table",
        {},
        el("thead", {}, el("tr", {}, el("th", {}, "Spec"), el("th", {}, "Count"))),
        el("tbody", {}, ...(bd.length ? bd.map(b =>
          el("tr", {}, el("td", {}, b.spec), el("td", {}, String(b.count)))
        ) : [el("tr", {}, el("td", {colspan:"2"}, el("span", {class:"muted"}, "No spec entries found.")))]))
      );
      app.append(el("div", {class:"card"},
        el("h3", {}, "Spec breakdown"),
        table
      ));
    }
  </script>
</body>
</html>